<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KANDY WORLD - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .sidebar-link { transition: background-color 0.2s, color 0.2s; }
        .sidebar-link-active { @apply bg-teal-600 text-white; }
        body { scrollbar-gutter: stable; }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; display: inline-block; }
        .status-new { background-color: #f59e0b; color: white; }
        .status-confirmed { background-color: #22c55e; color: white; }
        .status-rejected { background-color: #ef4444; color: white; }
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div class="flex min-h-screen">
        <aside class="w-64 bg-gray-800 text-white flex flex-col">
            <div class="p-6 text-2xl font-bold border-b border-gray-700"> KANDY WORLD </div>
            <nav class="flex-1 p-4 space-y-2">
                <a href="#dashboard" class="sidebar-link sidebar-link-active flex items-center py-2.5 px-4 rounded-md hover:bg-gray-700">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                    Dashboard
                </a>
                <a href="#orders" class="sidebar-link flex items-center py-2.5 px-4 rounded-md hover:bg-gray-700">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                    Orders
                </a>
                <a href="#products" class="sidebar-link flex items-center py-2.5 px-4 rounded-md hover:bg-gray-700">
                   <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
                    Products
                </a>
                <a href="#categories" class="sidebar-link flex items-center py-2.5 px-4 rounded-md hover:bg-gray-700">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
                    Categories
                </a>
            </nav>
        </aside>

        <main id="main-content" class="flex-1 p-8">
            </main>
    </div>

    <div id="order-details-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden modal">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto modal-content">
            <div class="p-6 relative">
                <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
                <div id="modal-order-details">
                    <p>Loading details...</p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="edit-product-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden modal">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[95vh] overflow-y-auto modal-content">
            <div class="p-8">
                 <h2 class="text-2xl font-bold mb-6 text-gray-800">Edit Product</h2>
                 <form id="editProductForm" class="space-y-6">
                    <input type="hidden" id="editProductId">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="editProductName" class="block text-sm font-medium text-gray-700">Product Name</label>
                            <input type="text" id="editProductName" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500">
                        </div>
                        <div>
                            <label for="editProductPrice" class="block text-sm font-medium text-gray-700">Price (Rs.)</label>
                            <input type="number" id="editProductPrice" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500">
                        </div>
                    </div>
                    <div>
                        <label for="editProductDescription" class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea id="editProductDescription" rows="4" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500"></textarea>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                         <div>
                             <label class="block text-sm font-medium text-gray-700">Main Image</label>
                             <div class="mt-2 flex items-center gap-4">
                                 <img id="editProductImagePreview" src="https://placehold.co/100x100?text=Image" class="w-24 h-24 object-cover rounded-md bg-gray-100">
                                 <input type="hidden" id="currentImageUrl">
                                 <div>
                                     <label for="editProductImageFile" class="cursor-pointer bg-white py-2 px-3 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">Change</label>
                                     <input type="file" id="editProductImageFile" class="sr-only">
                                     <p id="editFileStatus" class="text-xs text-gray-500 mt-1">Select a new file.</p>
                                 </div>
                             </div>
                         </div>
                         <div>
                             <label class="block text-sm font-medium text-gray-700">Hover Image</label>
                             <div class="mt-2 flex items-center gap-4">
                                 <img id="editProductImagePreview2" src="https://placehold.co/100x100?text=Hover" class="w-24 h-24 object-cover rounded-md bg-gray-100">
                                 <input type="hidden" id="currentImageUrl2">
                                 <div>
                                     <label for="editProductImageFile2" class="cursor-pointer bg-white py-2 px-3 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">Change</label>
                                     <input type="file" id="editProductImageFile2" class="sr-only">
                                     <p id="editFileStatus2" class="text-xs text-gray-500 mt-1">Select a new file.</p>
                                 </div>
                             </div>
                         </div>
                     </div>
                    <div>
                        <label for="editProductCategory" class="block text-sm font-medium text-gray-700">Category</label>
                        <select id="editProductCategory" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500">
                            </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Manage Stock Status</label>
                        <div id="edit-sizes-container" class="mt-2 space-y-2">
                            </div>
                    </div>
                    <div class="text-right pt-4 space-x-3">
                        <button type="button" id="cancel-edit-product-btn" class="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">Cancel</button>
                        <button type="submit" class="py-2 px-6 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-teal-600 hover:bg-teal-700">Update Product</button>
                    </div>
                    <div id="editStatusMessage" class="mt-4 text-center font-medium"></div>
                 </form>
            </div>
        </div>
    </div>


    <script type="module">
        // Import from the config file
        import { db, uploadImageToImgBB } from './firebase-config.js'; 
        // Import necessary Firestore functions
        import { collection, getDocs, addDoc, serverTimestamp, query, orderBy, doc, deleteDoc, updateDoc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        // --- CONFIG AND INITIALIZATION ---
        const MASTER_SIZES = ['XS', 'S', 'M', 'L', 'XL', 'XXL', '30', '32', '34', '36', '38', '40'];
        let salesChartInstance;
        let orderStatusChartInstance;

        // --- CORE LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!db) {
                 document.getElementById('main-content').innerHTML = `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4" role="alert"><p class="font-bold">Database Connection Failed</p><p>Check if firebase-config.js is correct and linked properly.</p></div>`;
                 return;
            }

            document.getElementById('main-content').addEventListener('click', handleMainContentClick);
            
            ['order-details-modal', 'edit-product-modal'].forEach(modalId => {
                document.getElementById(modalId)?.addEventListener('click', (e) => {
                    if (e.target.id === modalId || e.target.closest('#close-modal-btn, #cancel-edit-product-btn')) {
                        document.getElementById(modalId).classList.add('hidden');
                    }
                });
            });
            
            document.getElementById('editProductForm').addEventListener('submit', handleEditProductSubmit);
            document.getElementById('editProductImageFile').addEventListener('change', (e) => {
                 document.getElementById('editFileStatus').textContent = e.target.files[0] ? e.target.files[0].name : 'Select a new file...';
            });
            document.getElementById('editProductImageFile2').addEventListener('change', (e) => {
                 document.getElementById('editFileStatus2').textContent = e.target.files[0] ? e.target.files[0].name : 'Select a new file...';
            });

            const sidebarLinks = document.querySelectorAll('.sidebar-link');
            const navigate = () => {
                const hash = window.location.hash || '#dashboard';
                sidebarLinks.forEach(link => link.classList.toggle('sidebar-link-active', link.getAttribute('href') === hash));
                renderContent(hash);
            };
            window.addEventListener('hashchange', navigate);
            navigate();
        });
        
        async function renderContent(hash) {
            const mainContainer = document.getElementById('main-content');
            mainContainer.innerHTML = `<div class="text-center p-8 text-gray-500">Loading Content...</div>`;
            try {
                switch (hash) {
                    case '#orders': await renderOrdersPage(mainContainer); break;
                    case '#products': await renderProductsPage(mainContainer); break;
                    case '#categories': await renderCategoriesPage(mainContainer); break; 
                    case '#dashboard': default: await renderDashboardPage(mainContainer); break;
                }
            } catch (error) {
                console.error("Failed to render content:", error);
                mainContainer.innerHTML = `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4"><p class="font-bold">Could not load page content.</p><p>Check the console (F12) for details.</p></div>`;
            }
        }

        async function fetchOrders() { return await getDocs(query(collection(db, 'orders'), orderBy('timestamp', 'desc'))); }
        async function fetchProducts() { return await getDocs(query(collection(db, 'products'), orderBy('createdAt', 'desc'))); }
        async function fetchCategories() { return await getDocs(query(collection(db, 'categories'), orderBy('name'))); }

        // --- PAGE RENDERERS ---
        async function renderDashboardPage(container) { 
            container.innerHTML = `<h1 class="text-3xl font-bold text-gray-800 mb-6">Dashboard</h1><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"><div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-gray-500">Total Revenue</h3><p id="total-revenue" class="text-3xl font-bold">...</p></div><div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-gray-500">Total Orders</h3><p id="total-orders" class="text-3xl font-bold">...</p></div><div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-gray-500">New Orders</h3><p id="new-orders" class="text-3xl font-bold">...</p></div><div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-gray-500">Total Products</h3><p id="total-products" class="text-3xl font-bold">...</p></div></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div class="bg-white p-6 rounded-lg shadow-md"><h3 class="font-bold mb-4">Sales (Last 7 Days)</h3><canvas id="salesChart"></canvas></div><div class="bg-white p-6 rounded-lg shadow-md"><h3 class="font-bold mb-4">Order Status</h3><canvas id="orderStatusChart"></canvas></div></div>`;
            const [orderDocs, productDocs] = await Promise.all([fetchOrders(), fetchProducts()]);
            const ordersData = orderDocs.docs.map(d => d.data());
            document.getElementById('total-revenue').textContent = `Rs. ${ordersData.reduce((sum, order) => sum + (order.payment?.total || 0), 0).toLocaleString()}`;
            document.getElementById('total-orders').textContent = orderDocs.size;
            document.getElementById('new-orders').textContent = ordersData.filter(o => o.status === 'New').length;
            document.getElementById('total-products').textContent = productDocs.size;
            renderSalesChart(ordersData);
            renderOrderStatusChart(ordersData);
        }

        async function renderOrdersPage(container) {
            container.innerHTML = `<h1 class="text-3xl font-bold text-gray-800 mb-6">Manage Orders</h1><div id="orders-container" class="space-y-6"></div>`;
            const orderDocs = (await fetchOrders()).docs;
            const ordersContainer = document.getElementById('orders-container');
            if (orderDocs.length === 0) { ordersContainer.innerHTML = '<p class="text-gray-600 bg-white p-6 rounded-lg shadow-md">No orders found.</p>'; return; }
            ordersContainer.innerHTML = orderDocs.map(createOrderCardHTML).join('');
        }
        
        async function renderProductsPage(container) {
            container.innerHTML = `<div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold text-gray-800">Manage Products</h1><button id="show-add-product-form-btn" class="bg-teal-600 text-white font-bold py-2 px-4 rounded-md hover:bg-teal-700">+ Add New Product</button></div><div id="add-product-container" class="w-full bg-white p-8 rounded-xl shadow-lg mb-8 hidden"><h2 class="text-2xl font-bold mb-6 text-gray-800">Add a New Product</h2><form id="addProductForm" class="space-y-6"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label for="productName" class="block text-sm">Product Name</label><input type="text" id="productName" required class="w-full mt-1 px-4 py-2 border rounded-md"></div><div><label for="productPrice" class="block text-sm">Price (Rs.)</label><input type="number" id="productPrice" required class="w-full mt-1 px-4 py-2 border rounded-md"></div></div><div><label for="productDescription" class="block text-sm">Description</label><textarea id="productDescription" rows="4" class="w-full mt-1 px-4 py-2 border rounded-md"></textarea></div><div><label for="productCategory" class="block text-sm">Category</label><select id="productCategory" required class="w-full mt-1 px-4 py-2 border rounded-md bg-white"><option value="">Select a Category</option></select></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label for="productImageFile" class="block text-sm">Main Image</label><input type="file" id="productImageFile" required accept="image/*" class="w-full mt-1 text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100"></div><div><label for="productImageFile2" class="block text-sm">Hover Image (Optional)</label><input type="file" id="productImageFile2" accept="image/*" class="w-full mt-1 text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-yellow-50 file:text-yellow-700 hover:file:bg-yellow-100"></div></div><div><label class="block text-sm">Available Sizes (In Stock)</label><div id="add-sizes-container" class="grid grid-cols-4 sm:grid-cols-6 gap-2 mt-2"></div></div><div class="text-right pt-4"><button type="button" id="cancel-add-product-btn" class="border font-bold py-2 px-4 rounded-md mr-2">Cancel</button><button type="submit" class="bg-teal-600 text-white font-bold py-2 px-4 rounded-md">Add Product</button></div><div id="statusMessage" class="mt-4 text-center font-medium"></div></form></div><div class="bg-white p-6 rounded-lg shadow-md"><div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="border-b bg-gray-50"><th class="p-4 font-semibold">Image</th><th class="p-4 font-semibold">Name</th><th class="p-4 font-semibold">Category</th><th class="p-4 font-semibold">Price</th><th class="p-4 font-semibold">Available Sizes</th><th class="p-4 font-semibold">Actions</th></tr></thead><tbody id="products-table-body"></tbody></table></div></div>`;
            
            const sizesContainer = document.getElementById('add-sizes-container');
            sizesContainer.innerHTML = MASTER_SIZES.map(size => `<div><input type="checkbox" id="size-add-${size}" name="sizes" value="${size}" class="size-checkbox hidden peer"><label for="size-add-${size}" class="block w-full text-center border rounded-md py-2 px-3 text-sm cursor-pointer peer-checked:bg-teal-600 peer-checked:text-white peer-checked:border-teal-600">${size}</label></div>`).join('');

            await populateCategoryDropdown(document.getElementById('productCategory'));
            await populateProductsTable();
        }

        async function renderCategoriesPage(container) {
            container.innerHTML = `<div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold text-gray-800">Manage Categories</h1></div><div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md"><h2 class="text-xl font-bold text-gray-800 mb-4">Existing Categories</h2><div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="border-b bg-gray-50"><th class="p-4 font-semibold">Image</th><th class="p-4 font-semibold">Category Name</th><th class="p-4 font-semibold">Actions</th></tr></thead><tbody id="categories-table-body"></tbody></table></div></div><div class="bg-white p-8 rounded-xl shadow-lg"><h2 class="text-xl font-bold mb-6 text-gray-800">Add New Category</h2><form id="addCategoryForm" class="space-y-4"><div><label for="categoryName" class="block text-sm font-medium text-gray-700">Category Name</label><input type="text" id="categoryName" required class="mt-1 w-full px-4 py-2 border rounded-md"></div><div><label for="categoryImageUrl" class="block text-sm font-medium text-gray-700">Image URL</label><input type="url" id="categoryImageUrl" required placeholder="https://example.com/image.jpg" class="mt-1 w-full px-4 py-2 border rounded-md"><p class="text-xs text-gray-500 mt-1">This image will be shown on the homepage above the products of this category.</p></div><div class="text-right pt-2"><button type="submit" class="bg-teal-600 text-white font-bold py-2 px-4 rounded-md w-full">Add Category</button></div><div id="categoryStatusMessage" class="mt-3 text-center font-medium"></div></form></div></div>`;
            
            await populateCategoriesTable();

            document.getElementById('addCategoryForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const statusMsg = document.getElementById('categoryStatusMessage');
                const categoryName = form.categoryName.value.trim();
                const imageUrl = form.categoryImageUrl.value.trim();

                if (!categoryName || !imageUrl) {
                    statusMsg.textContent = 'Please fill all fields.'; statusMsg.style.color = 'red'; return;
                }
                statusMsg.textContent = 'Adding...'; statusMsg.style.color = 'blue';
                try {
                    const categoryRef = doc(db, "categories", categoryName);
                    await setDoc(categoryRef, { name: categoryName, imageUrl: imageUrl });
                    statusMsg.textContent = 'Category added successfully!'; statusMsg.style.color = 'green';
                    form.reset(); await populateCategoriesTable();
                } catch (error) {
                    console.error("Error adding category:", error);
                    statusMsg.textContent = `Error: ${error.message}`; statusMsg.style.color = 'red';
                }
            });
        }

        // --- HELPER FUNCTIONS ---
        function createOrderCardHTML(orderDoc) {
            const orderData = orderDoc.data(); const orderId = orderDoc.id; const actionButtons = orderData.status === 'New' ? `<div class="flex space-x-2"><button data-id="${orderId}" class="confirm-btn bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded text-xs">Confirm</button><button data-id="${orderId}" class="reject-btn bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded text-xs">Reject</button></div>` : ''; return `<div class="bg-white p-6 rounded-lg shadow-md border order-card-clickable cursor-pointer" id="${orderId}"><div class="flex flex-wrap justify-between items-start border-b pb-4 mb-4 gap-4"><div><p class="font-bold text-lg">${orderData.customer.firstName} ${orderData.customer.lastName}</p><p class="text-sm text-gray-600">${orderData.customer.phone}</p><p class="text-sm text-gray-600">${orderData.customer.address}, ${orderData.customer.city}</p></div><div class="text-right flex-shrink-0"><p class="font-semibold text-lg">Total: <span class="text-teal-600">Rs. ${orderData.payment.total.toLocaleString()}</span></p><p class="text-xs text-gray-500">ID: ${orderId.substring(0,6)}... | ${orderData.timestamp.toDate().toLocaleString('en-LK')}</p><span class="status-badge ${orderData.status === 'New' ? 'status-new' : orderData.status === 'Confirmed' ? 'status-confirmed' : 'status-rejected'} mt-2">${orderData.status}</span></div></div><div class="flex items-center space-x-4 mb-4"><img src="${orderData.item.imageUrl}" class="w-16 h-16 rounded-md object-cover bg-gray-100"><div><p class="font-semibold">${orderData.item.name}</p><p class="text-sm">Size: ${orderData.item.size} | Qty: ${orderData.item.quantity}</p></div></div><div class="flex justify-between items-center text-sm bg-gray-50 p-3 rounded-md"><p><strong>Notes:</strong> ${orderData.customer.notes || 'None'}</p><div class="action-buttons">${actionButtons}</div></div></div>`;
        }

        async function populateProductsTable() {
            const productDocs = (await fetchProducts()).docs;
            const tableBody = document.getElementById('products-table-body');
            if (!tableBody) return;
            if (productDocs.length === 0) { tableBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center">No products found.</td></tr>'; return; }
            tableBody.innerHTML = productDocs.map(doc => {
                const p = doc.data(); 
                const displayImage = (p.imageUrls && p.imageUrls[0]) ? p.imageUrls[0] : (p.imageUrl || 'https://placehold.co/100x100?text=No+Image');
                const availableSizes = (p.sizes || []).filter(s => s.stock === 'In Stock').map(s => s.size).join(', ');
                const stockStatusHtml = availableSizes ? `<span class="text-green-800">${availableSizes}</span>` : `<span class="text-red-800">Sold Out</span>`;
                return `<tr class="border-b hover:bg-gray-50"><td class="p-2"><img src="${displayImage}" alt="${p.name || ''}" class="w-16 h-16 object-cover rounded-md bg-gray-100"></td><td class="p-4 font-medium">${p.name || 'N/A'}</td><td class="p-4">${p.category || 'N/A'}</td><td class="p-4">Rs. ${(p.price || 0).toLocaleString()}</td><td class="p-4 text-sm">${stockStatusHtml}</td><td class="p-4"><button data-id="${doc.id}" class="edit-btn text-blue-600 hover:underline text-sm">Edit</button><button data-id="${doc.id}" class="delete-btn text-red-600 hover:underline text-sm ml-2">Delete</button></td></tr>`;
            }).join('');
        }

        async function populateCategoriesTable() {
            const categoryDocs = (await fetchCategories()).docs;
            const tableBody = document.getElementById('categories-table-body');
            if (!tableBody) return;
            if (categoryDocs.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-500">No categories found. Add one to get started!</td></tr>';
                return;
            }
            tableBody.innerHTML = categoryDocs.map(doc => {
                const cat = doc.data();
                return `<tr class="border-b hover:bg-gray-50">
                    <td class="p-2"><img src="${cat.imageUrl}" alt="${cat.name}" class="w-24 h-16 object-cover rounded-md bg-gray-100"></td>
                    <td class="p-4 font-medium">${cat.name}</td>
                    <td class="p-4"><button data-id="${doc.id}" class="delete-category-btn text-red-600 hover:underline text-sm">Delete</button></td>
                </tr>`;
            }).join('');
        }
        
        async function populateCategoryDropdown(selectElement) {
            if (!selectElement) return;
            const categoryDocs = (await fetchCategories()).docs;
            selectElement.innerHTML = '<option value="">Select a Category</option>';
            categoryDocs.forEach(doc => {
                const catName = doc.data().name;
                selectElement.innerHTML += `<option value="${catName}">${catName}</option>`;
            });
        }

        async function showOrderDetailsModal(orderId) { 
            const modal = document.getElementById('order-details-modal'); const modalBody = document.getElementById('modal-order-details'); modalBody.innerHTML = '<p>Loading details...</p>'; modal.classList.remove('hidden'); try { const orderDoc = await getDoc(doc(db, "orders", orderId)); if (!orderDoc.exists()) { modalBody.innerHTML = '<p class="text-red-500">Error: Order not found.</p>'; return; } const data = orderDoc.data(); modalBody.innerHTML = `<h2 class="text-2xl font-bold text-gray-800 mb-4">Order Details</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><img src="${data.item.imageUrl}" alt="${data.item.name}" class="w-full rounded-lg object-cover mb-4 bg-gray-100" style="aspect-ratio: 1/1;"><h3 class="font-bold text-lg">${data.item.name}</h3><p><strong>Size:</strong> ${data.item.size} | <strong>Quantity:</strong> ${data.item.quantity}</p></div><div class="space-y-4"><div><h4 class="font-semibold text-gray-600 border-b pb-1 mb-2">Customer & Shipping Info</h4><p><strong>Name:</strong> ${data.customer.firstName} ${data.customer.lastName}</p><p><strong>Phone:</strong> ${data.customer.phone}</p><p><strong>Address:</strong> ${data.customer.address}, ${data.customer.city}</p><p><strong>Notes:</strong> ${data.customer.notes || 'None'}</p></div><div><h4 class="font-semibold text-gray-600 border-b pb-1 mb-2">Payment Details</h4><div class="flex justify-between"><p>Subtotal:</p> <p>Rs. ${data.payment.subtotal.toLocaleString()}</p></div><div class="flex justify-between"><p>Delivery Fee:</p> <p>Rs. ${data.payment.deliveryFee.toLocaleString()}</p></div><div class="flex justify-between font-bold text-lg mt-2 border-t pt-2"><p>Total:</p> <p>Rs. ${data.payment.total.toLocaleString()}</p></div></div><div><h4 class="font-semibold text-gray-600 border-b pb-1 mb-2">Order Status</h4><p><strong>Order ID:</strong> ${orderId}</p><p><strong>Date:</strong> ${data.timestamp.toDate().toLocaleString('en-LK')}</p><p><strong>Status:</strong> <span class="status-badge ${data.status === 'New' ? 'status-new' : data.status === 'Confirmed' ? 'status-confirmed' : 'status-rejected'}">${data.status}</span></p></div></div></div>`; } catch (error) { console.error("Error fetching order details:", error); modalBody.innerHTML = '<p class="text-red-500">Could not load order details.</p>'; }
        }

        function createEmailHtml(orderData, orderId) {
            return `<div style="font-family: Arial, sans-serif; max-width: 600px; margin: auto; border: 1px solid #ddd; padding: 20px;"><h2 style="color: #0d9488; text-align: center;">Your KANDY WORLD Order is Confirmed!</h2><p>Hi ${orderData.customer.firstName},</p><p>Your order number is <strong>#${orderId.substring(0,6)}</strong>.</p><h3 style="border-bottom: 1px solid #ddd; padding-bottom: 5px;">Order Summary</h3><table style="width: 100%; border-collapse: collapse;"><tr style="background-color: #f3f4f6;"><th style="padding: 10px; text-align: left;">Product</th><th style="padding: 10px; text-align: right;">Price</th></tr><tr><td style="padding: 10px; border-bottom: 1px solid #ddd;">${orderData.item.name}<br><small>Size: ${orderData.item.size}, Qty: ${orderData.item.quantity}</small></td><td style="padding: 10px; border-bottom: 1px solid #ddd; text-align: right;">Rs. ${orderData.payment.subtotal.toLocaleString()}</td></tr></table><table style="width: 100%; margin-top: 20px;"><tr><td style="text-align: right;">Subtotal:</td><td style="text-align: right;">Rs. ${orderData.payment.subtotal.toLocaleString()}</td></tr><tr><td style="text-align: right;">Delivery:</td><td style="text-align: right;">Rs. ${orderData.payment.deliveryFee.toLocaleString()}</td></tr><tr><td style="text-align: right; font-weight: bold;">Total:</td><td style="text-align: right; font-weight: bold;">Rs. ${orderData.payment.total.toLocaleString()}</td></tr></table><h3 style="border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-top: 20px;">Shipping Address</h3><p style="line-height: 1.6;">${orderData.customer.firstName} ${orderData.customer.lastName}<br>${orderData.customer.address}<br>${orderData.customer.city}<br>${orderData.customer.phone}</p><p>Thank you for shopping with us!</p><p><strong>- KANDY WORLD Team</strong></p></div>`;
        }

        async function openEditProductModal(productId) {
            const modal = document.getElementById('edit-product-modal');
            const form = document.getElementById('editProductForm');
            form.reset();
            document.getElementById('editStatusMessage').textContent = '';
            
            try {
                const productDoc = await getDoc(doc(db, "products", productId));
                if (!productDoc.exists()) { alert("Product not found!"); return; }
                
                const data = productDoc.data();
                const imageUrls = data.imageUrls || [];

                document.getElementById('editProductId').value = productId;
                document.getElementById('editProductName').value = data.name || '';
                document.getElementById('editProductPrice').value = data.price || 0;
                document.getElementById('editProductDescription').value = data.description || '';
                
                document.getElementById('editProductImagePreview').src = imageUrls[0] || data.imageUrl || 'https://placehold.co/100x100?text=Image';
                document.getElementById('currentImageUrl').value = imageUrls[0] || data.imageUrl || '';
                document.getElementById('editFileStatus').textContent = 'Select a new file.';
                
                document.getElementById('editProductImagePreview2').src = imageUrls[1] || 'https://placehold.co/100x100?text=Hover';
                document.getElementById('currentImageUrl2').value = imageUrls[1] || '';
                document.getElementById('editFileStatus2').textContent = 'Select a new file.';
                
                const categorySelect = document.getElementById('editProductCategory');
                await populateCategoryDropdown(categorySelect);
                categorySelect.value = data.category || '';

                const editSizesContainer = document.getElementById('edit-sizes-container');
                editSizesContainer.innerHTML = '';
                if (data.sizes && data.sizes.length > 0) {
                    editSizesContainer.innerHTML = data.sizes.map(s => `
                        <div class="flex items-center justify-between p-2 border rounded-md bg-gray-50 size-edit-entry" data-size="${s.size}">
                            <span class="font-medium text-gray-800">${s.size}</span>
                            <select class="size-stock-edit border-gray-300 rounded-md shadow-sm text-sm focus:ring-teal-500 focus:border-teal-500">
                                <option ${s.stock === 'In Stock' ? 'selected' : ''}>In Stock</option>
                                <option ${s.stock === 'Sold Out' ? 'selected' : ''}>Sold Out</option>
                            </select>
                        </div>
                    `).join('');
                } else {
                    editSizesContainer.innerHTML = '<p class="text-sm text-gray-500">No sizes were defined for this product.</p>';
                }
                modal.classList.remove('hidden');

            } catch (error) {
                console.error("Error fetching product for edit:", error);
                alert("Could not load product details.");
            }
        }
        
        async function handleEditProductSubmit(e) {
            e.preventDefault();
            const statusMsg = document.getElementById('editStatusMessage');
            statusMsg.textContent = 'Updating...'; statusMsg.style.color = 'blue';

            const productId = document.getElementById('editProductId').value;
            const imageFile1 = document.getElementById('editProductImageFile').files[0];
            const imageFile2 = document.getElementById('editProductImageFile2').files[0];
            
            let imageUrl1 = document.getElementById('currentImageUrl').value;
            let imageUrl2 = document.getElementById('currentImageUrl2').value;
            
            try {
                if (imageFile1) {
                    statusMsg.textContent = 'Uploading main image...';
                    imageUrl1 = await uploadImageToImgBB(imageFile1);
                }
                if (imageFile2) {
                    statusMsg.textContent = 'Uploading hover image...';
                    imageUrl2 = await uploadImageToImgBB(imageFile2);
                }
                
                const sizes = Array.from(document.querySelectorAll('#edit-sizes-container .size-edit-entry')).map(entry => ({
                    size: entry.dataset.size,
                    stock: entry.querySelector('.size-stock-edit').value
                }));

                const updatedData = {
                    name: document.getElementById('editProductName').value,
                    price: parseFloat(document.getElementById('editProductPrice').value),
                    description: document.getElementById('editProductDescription').value,
                    category: document.getElementById('editProductCategory').value,
                    imageUrls: [imageUrl1, imageUrl2].filter(url => url),
                    imageUrl: imageUrl1,
                    sizes: sizes
                };
                
                await updateDoc(doc(db, "products", productId), updatedData);
                statusMsg.textContent = 'Product updated successfully!'; statusMsg.style.color = 'green';
                await populateProductsTable();
                setTimeout(() => { document.getElementById('edit-product-modal').classList.add('hidden'); }, 1500);

            } catch (error) {
                console.error("Error updating product: ", error);
                statusMsg.textContent = `Error: ${error.message}`; statusMsg.style.color = 'red';
            }
        }

        async function handleMainContentClick(e) {
            const target = e.target;
            
            if (target.id === 'show-add-product-form-btn') document.getElementById('add-product-container').classList.remove('hidden');
            if (target.id === 'cancel-add-product-btn') document.getElementById('add-product-container').classList.add('hidden');
            if (target.closest('form')?.id === 'addProductForm' && target.type === 'submit') {
                e.preventDefault();
                const form = target.closest('form'); const statusMsg = document.getElementById('statusMessage');
                statusMsg.textContent = 'Adding...'; statusMsg.style.color = 'blue';
                
                const imageFile1 = form.productImageFile.files[0];
                const imageFile2 = form.productImageFile2.files[0];

                if (!imageFile1) {
                    statusMsg.textContent = 'Please select a main image file.'; statusMsg.style.color = 'red'; return;
                }
                
                try {
                    const selectedSizes = Array.from(form.querySelectorAll('input[name="sizes"]:checked'));
                    if (selectedSizes.length === 0) {
                        statusMsg.textContent = 'Please select at least one available size.'; statusMsg.style.color = 'red'; return;
                    }

                    statusMsg.textContent = 'Uploading main image...';
                    const imageUrl1 = await uploadImageToImgBB(imageFile1);
                    let imageUrl2 = '';
                    if (imageFile2) {
                        statusMsg.textContent = 'Uploading hover image...';
                        imageUrl2 = await uploadImageToImgBB(imageFile2);
                    }

                    statusMsg.textContent = 'Processing data...';
                    const sizes = selectedSizes.map(checkbox => ({ size: checkbox.value, stock: 'In Stock' }));
                    
                    const productData = {
                        name: form.productName.value,
                        price: parseFloat(form.productPrice.value),
                        description: form.productDescription.value,
                        category: form.productCategory.value,
                        imageUrls: [imageUrl1, imageUrl2].filter(url => url),
                        imageUrl: imageUrl1,
                        sizes: sizes,
                        createdAt: serverTimestamp()
                    };

                    await addDoc(collection(db, "products"), productData);
                    statusMsg.textContent = 'Success!'; statusMsg.style.color = 'green';
                    form.reset();
                    document.getElementById('add-product-container').classList.add('hidden');
                    await populateProductsTable();
                } catch (error) {
                    statusMsg.textContent = `Error: ${error.message}`;
                    statusMsg.style.color = 'red';
                }
            }
            
            if (target.classList.contains('edit-btn')) {
                openEditProductModal(target.dataset.id);
            }
            if (target.classList.contains('delete-btn')) {
                const productId = target.dataset.id;
                if (confirm('Are you sure you want to delete this product?')) { await deleteDoc(doc(db, "products", productId)); await populateProductsTable(); }
            }
            if (target.classList.contains('delete-category-btn')) {
                const categoryId = target.dataset.id;
                if (confirm(`Are you sure you want to delete the category "${categoryId}"? This cannot be undone.`)) {
                    await deleteDoc(doc(db, "categories", categoryId));
                    await populateCategoriesTable();
                }
            }
            
            if (target.classList.contains('confirm-btn') || target.classList.contains('reject-btn')) {
                const orderId = target.dataset.id; target.disabled = true; target.textContent = '...';
                const orderRef = doc(db, "orders", orderId); const newStatus = target.classList.contains('confirm-btn') ? 'Confirmed' : 'Rejected';
                try {
                    await updateDoc(orderRef, { status: newStatus });
                    if (newStatus === 'Confirmed') {
                        const orderDoc = await getDoc(orderRef);
                        if(orderDoc.exists() && orderDoc.data().customer.email) { await addDoc(collection(db, "mail"), { to: [orderDoc.data().customer.email], message: { subject: `Your Order #${orderId.substring(0, 6)} is Confirmed!`, html: createEmailHtml(orderDoc.data(), orderId) } }); }
                    }
                    const orderCard = document.getElementById(orderId);
                    if (orderCard) {
                        orderCard.querySelector('.status-badge').textContent = newStatus;
                        orderCard.querySelector('.status-badge').className = `status-badge ${newStatus === 'Confirmed' ? 'status-confirmed' : 'status-rejected'}`;
                        orderCard.querySelector('.action-buttons').innerHTML = '';
                    }
                } catch (error) { console.error("Error updating order:", error); alert("Failed to update order status."); target.disabled = false; target.textContent = newStatus === 'Confirmed' ? 'Confirm' : 'Reject'; }
            }
            const orderCard = target.closest('.order-card-clickable');
            if (orderCard && !target.closest('button')) {
                showOrderDetailsModal(orderCard.id);
            }
        }

        // --- CHART RENDERING ---
        function renderSalesChart(ordersData) {
            const ctx = document.getElementById('salesChart')?.getContext('2d'); if(!ctx) return; const last7Days = [...Array(7)].map((_, i) => { const d = new Date(); d.setDate(d.getDate() - i); return d.toISOString().split('T')[0]; }).reverse(); const salesData = last7Days.map(day => ordersData.filter(o => o.timestamp?.toDate().toISOString().split('T')[0] === day).reduce((sum, o) => sum + (o.payment?.total || 0), 0)); if(salesChartInstance) salesChartInstance.destroy(); salesChartInstance = new Chart(ctx, { type: 'bar', data: { labels: last7Days, datasets: [{ label: 'Sales (Rs.)', data: salesData, backgroundColor: 'rgba(13, 148, 136, 0.6)' }] }, options: { scales: { y: { beginAtZero: true } } } });
        }
        function renderOrderStatusChart(ordersData) {
            const ctx = document.getElementById('orderStatusChart')?.getContext('2d'); if(!ctx) return; const statusCounts = ordersData.reduce((acc, order) => { const status = order.status || 'Unknown'; acc[status] = (acc[status] || 0) + 1; return acc; }, {}); if(orderStatusChartInstance) orderStatusChartInstance.destroy(); orderStatusChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(statusCounts), datasets: [{ data: Object.values(statusCounts), backgroundColor: ['#f59e0b', '#22c55e', '#ef4444', '#3b82f6', '#6b7280'] }] } });
        }

    </script>
</body>
</html>